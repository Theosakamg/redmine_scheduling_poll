<%= f.hidden_field :issue_id %>

<div>
  <p class="contextual">
    <%= link_to_function 'Toggle Date Picker', 'scheduling_polls_update_date_picker("toggle")' %>
  </p>
  <%= f.fields_for :scheduling_poll_item do |f_item| %>
    <%= render :partial => "scheduling_poll_item_form", :locals => { :f => f, :f_item => f_item } %>
  <% end %>
  <% add_item_tmpl = capture do %>
    <%= f.fields_for :scheduling_poll_item, SchedulingPollItem.new, :child_index => "CHILD_INDEX" do |f_item| %>
      <%= render :partial => "scheduling_poll_item_form", :locals => { :f => f, :f_item => f_item } %>
    <% end %>
  <% end %>
  <p>
    <%= link_to_function 'Add item', "scheduling_polls_add_item(\"#{escape_javascript(add_item_tmpl)}\")", :class => 'icon icon-add', :id => 'scheduling_poll_add_item_link' %>
  </p>
</div>

<div class="actions">
  <%= f.submit %>
</div>

<%= javascript_tag <<EOD
function scheduling_polls_update_date_picker(enable) {
  "use strict";
  if (enable === undefined) {
    enable = ($("form .ui-datepicker-trigger").length > 0)? true : false;
  } else if (enable === "toggle") {
    enable = ($("form .ui-datepicker-trigger").length > 0)? false : true;
  }
  if (enable) {
    $("form input[type=text]:not([disabled]):not([readonly])").datepicker({
      dateFormat: 'yy-mm-dd', showOn: 'button', buttonImageOnly: true,
      buttonImage: '#{path_to_image('/images/calendar.png')}',
      showButtonPanel: true, showWeek: true, showOtherMonths: true,
      selectOtherMonths: true, changeMonth: true, changeYear: true
    });
  } else {
    $("form input[type=text]").datepicker("destroy");
  }
}
$(function() { scheduling_polls_update_date_picker(true); });
function scheduling_polls_add_item(template) {
  "use strict";

  var child_index = $("#scheduling_poll_add_item_link").parents("form").find("input[type=text][id^=scheduling_poll_scheduling_poll_item_attributes_]").length;
  $("#scheduling_poll_add_item_link").parent().before(template.replace(/CHILD_INDEX/g, child_index));
  scheduling_polls_update_date_picker();
}
EOD
%>
